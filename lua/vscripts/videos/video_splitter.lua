ElevatorVideos = {
    ["sp_a1_intro1"] = { map = "sp_a1_intro1", arrival = "", departure = "" },
    ["sp_a1_intro2"] = { map = "sp_a1_intro2", arrival = "", departure = "" },
    ["sp_a1_intro3"] = { map = "sp_a1_intro3", arrival = "animalking", departure = "animalking", typeOverride = 11 },
    ["sp_a1_intro4"] = { map = "sp_a1_intro4", arrival = "exercises_horiz", departure = "exercises_horiz", typeOverride = 10 },
    ["sp_a1_intro5"] = { map = "sp_a1_intro5", arrival = "exercises_vert", departure = "exercises_vert", typeOverride = 9 },
    ["sp_a1_intro6"] = { map = "sp_a1_intro6", arrival = "plc_blue_vert", departure = "plc_blue_vert", typeOverride = 9 },
    ["sp_a1_intro7"] = { map = "sp_a1_intro7", arrival = "plc_blue_horiz", departure = "", typeOverride = 4 },
    ["sp_a2_intro"] = { map = "sp_a2_intro", arrival = "", departure = "plc_blue_horiz", typeOverride = 1 },
    ["sp_a2_laser_intro"] = { map = "sp_a2_laser_intro", arrival = "laser_portal", departure = "laser_portal", typeOverride = 12 },
    ["sp_a2_laser_stairs"] = { map = "sp_a2_laser_stairs", arrival = "laser_portal", departure = "laser_portal", typeOverride = 12 },
    ["sp_a2_dual_lasers"] = { map = "sp_a2_dual_lasers", arrival = "laser_portal", departure = "laser_portal", typeOverride = 12 },
    ["sp_a2_laser_over_goo"] = { map = "sp_a2_laser_over_goo", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_catapult_intro"] = { map = "sp_a2_catapult_intro", arrival = "faithplate", departure = "faithplate", typeOverride = 6 },
    ["sp_a2_trust_fling"] = { map = "sp_a2_trust_fling", arrival = "faithplate", departure = "faithplate", typeOverride = 6 },
    ["sp_a2_pit_flings"] = { map = "sp_a2_pit_flings", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_fizzler_intro"] = { map = "sp_a2_fizzler_intro", arrival = "fizzler", departure = "fizzler", typeOverride = 6 },
    ["sp_a2_sphere_peek"] = { map = "sp_a2_sphere_peek", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_ricochet"] = { map = "sp_a2_ricochet", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_bridge_intro"] = { map = "sp_a2_bridge_intro", arrival = "hard_light", departure = "hard_light", typeOverride = 12 },
    ["sp_a2_bridge_the_gap"] = { map = "sp_a2_bridge_the_gap", arrival = "hard_light", departure = "hard_light", typeOverride = 6 },
    ["sp_a2_turret_intro"] = { map = "sp_a2_turret_intro", arrival = "turret_exploded_grey", departure = "", typeOverride = 6 },
    ["sp_a2_laser_relays"] = { map = "sp_a2_laser_relays", arrival = "", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_turret_blocker"] = { map = "sp_a2_turret_blocker", arrival = "turret_exploded_grey", departure = "turret_exploded_grey", typeOverride = 6 },
    ["sp_a2_laser_vs_turret"] = { map = "sp_a2_laser_vs_turret", arrival = "turret_colours_type", departure = "turret_colours_type", typeOverride = 6 },
    ["sp_a2_pull_the_rug"] = { map = "sp_a2_pull_the_rug", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_column_blocker"] = { map = "sp_a2_column_blocker", arrival = "turret_dropin", departure = "turret_dropin", typeOverride = 6 },
    ["sp_a2_laser_chaining"] = { map = "sp_a2_laser_chaining", arrival = "turret_colours_type", departure = "turret_colours_type", typeOverride = 6 },
    ["sp_a2_triple_laser"] = { map = "sp_a2_triple_laser", arrival = "aperture_appear_vert", departure = "aperture_appear_vert", typeOverride = 9 },
    ["sp_a2_bts1"] = { map = "sp_a2_bts1", arrival = "aperture_appear_vert", departure = "", typeOverride = 9 },
    ["sp_a4_intro"] = { map = "sp_a4_intro", arrival = "", departure = "plc_blue_horiz", typeOverride = 6 },
    ["sp_a4_tb_intro"] = { map = "sp_a4_tb_intro", arrival = "exercises_horiz", departure = "exercises_horiz", typeOverride = 6 },
    ["sp_a4_tb_trust_drop"] = { map = "sp_a4_tb_trust_drop", arrival = "plc_blue_horiz", departure = "plc_blue_horiz", typeOverride = 6 },
    ["sp_a4_tb_wall_button"] = { map = "sp_a4_tb_wall_button", arrival = "", departure = "" },
    ["sp_a4_tb_polarity"] = { map = "sp_a4_tb_polarity", arrival = "exercises_horiz", departure = "exercises_horiz", typeOverride = 6 },
    ["sp_a4_tb_catch"] = { map = "sp_a4_tb_catch", arrival = "plc_blue_horiz", departure = "plc_blue_horiz", typeOverride = 6 },
    ["sp_a4_stop_the_box"] = { map = "sp_a4_stop_the_box", arrival = "bluescreen", departure = "bluescreen", typeOverride = 14 },
    ["sp_a4_laser_catapult"] = { map = "sp_a4_laser_catapult", arrival = "bluescreen", departure = "bluescreen", typeOverride = 14 },
    ["sp_a4_laser_platform"] = { map = "sp_a4_laser_platform", arrival = "bluescreen", departure = "", typeOverride = 14 },
    ["sp_a4_speed_tb_catch"] = { map = "sp_a4_speed_tb_catch", arrival = "", departure = "bluescreen", typeOverride = 14 },
    ["sp_a4_jump_polarity"] = { map = "sp_a4_jump_polarity", arrival = "bluescreen", departure = "bluescreen", typeOverride = 14 },
    ["sp_a4_finale1"] = { map = "sp_a4_finale1", arrival = "bluescreen", departure = "" },
}

ARRIVAL_VIDEO = 0
DEPARTURE_VIDEO = 1
ARRIVAL_DESTRUCTED_VIDEO = 2
DEPARTURE_DESTRUCTED_VIDEO = 3

OVERRIDE_VIDEOS = false
FIRST_CLEAN_MAP = "sp_a2_catapult_intro"

function Precache()
    local level = ElevatorVideos[game.GetMap()]

    if level then
        local movieName

        if level.additional and level.additional ~= "" then
            movieName = "media/" .. level.additional
        end

        if level.arrival and level.arrival ~= "" then
            movieName = "media/" .. (OVERRIDE_VIDEOS and "entry_emergency" or level.arrival) 
        end

        if level.departure and level.departure ~= "" then
            movieName = "media/" .. (OVERRIDE_VIDEOS and "exit_emergency" or level.departure) 
        end

        PrecacheMovie(movieName)
    end
end

-- stubs to supress error - will delete these soon.
function StopEntryVideo()
end

function StopExitVideo()
end

function StartEntryVideo()
end

function StartExitVideo()
end

function StartDestructedEntryVideo()
end

function StartDestructedExitVideo()
end

-- ============================

function StopArrivalVideo(width, height)
    EntFire("@arrival_video_master", "Disable", "", 0)
	EntFire("@arrival_video_master", "killhierarchy", "", 1.0)
	StopVideo(ARRIVAL_VIDEO,width,height)
end

function StopDepartureVideo(width,height)
    EntFire("@departure_video_master", "Disable", "", 0)
	EntFire("@departure_video_master", "killhierarchy", "", 1.0)
	StopVideo(DEPARTURE_VIDEO,width,height)
end

function StopVideo(videoType,width,height)
    for i = 0, width do
        for j = 0, height do
            local panelNum = 1 + width * j + i
            local signName

            if videoType == DEPARTURE_VIDEO or videoType == DEPARTURE_DESTRUCTED_VIDEO then
                signName = "@departure_sign_" .. panelNum
            else
                signName = "@arrival_sign_" .. panelNum
            end

            EntFire(signName, "Disable", "", 0)
			EntFire(signName, "killhierarchy", "", 1.0)
        end
    end
end

function StartArrivalVideo(width, height)
    StartDestructedArrivalVideo(width,height)
end

function StartDepartureVideo(width,height)
    StartDestructedDepartureVideo(width,height)
end

function StartDestructedArrivalVideo(width, height)
    local playDestructed = false

    if game.GetMap() == FIRST_CLEAN_MAP then
        playDestructed = false
    end

    local level = ElevatorVideos[game.GetMap()]

    if level and level.arrival and level.arrival ~= "" then
        local videoName = "media/"

        videoName = videoName .. (OVERRIDE_VIDEOS == 1 and "entry_emergency" or level.arrival)
        EntFire("@arrival_video_master", "SetMovie", videoName, 0)
    end

    EntFire("@arrival_video_master", "Enable", "", 0.1)
	StartVideo(playDestructed and ARRIVAL_DESTRUCTED_VIDEO or ARRIVAL_VIDEO, width, height)    
end

function StartDestructedDepartureVideo(width, height)
    local playDestructed = false

    if game.GetMap() == FIRST_CLEAN_MAP then
        playDestructed = false
    end

    local level = ElevatorVideos[game.GetMap()]

    if level and level.departure and level.departure ~= "" then
        local videoName = "media/"

        videoName = videoName .. (OVERRIDE_VIDEOS == 1 and "entry_emergency" or level.arrival)
        EntFire("@departure_video_master", "SetMovie", videoName, 0)
    end

    EntFire("@departure_video_master", "Enable", "", 0.1)
	StartVideo(playDestructed and DEPARTURE_DESTRUCTED_VIDEO or DEPARTURE_VIDEO, width, height)   
end

function StartVideo(videoType, width, height)
    local videoScaleType = 0
	local randomDestructChance = 0

    if videoType == ARRIVAL_DESTRUCTED_VIDEO or videoType == DEPARTURE_DESTRUCTED_VIDEO then
        videoScaleType = math.random(1, 5)
    else
        videoScaleType = math.random(6, 7)
    end

    local level = ElevatorVideos[game.GetMap()]
    if level.typeOverride then
        videoScaleType = level.typeOverride
    end

    if level.destructChance then
        randomDestructChance = level.destructChance
    end

    for i = 0, width do
        for j = 0, height do
            local panelNum = 1 + width * j + i
            local signName

            if videoType == DEPARTURE_VIDEO or videoType == DEPARTURE_DESTRUCTED_VIDEO then
                signName = "@departure_sign_" .. panelNum
            else
                signName = "@arrival_sign_" .. panelNum
            end

            if randomDestructChance > math.random(0,100) then
                EntFire(signName, "Kill", "", 0)
                continue
            end

            EntFire(signName, "SetUseCustomUVs", 1, 0)

            local uMin = (i+0.0001)/(width)
            local uMax = (i+1.0001)/(width)
            local vMin = (j+0.0001)/(height)
            local vMax = (j+1.0001)/(height)

            if videoScaleType == 0 then
                
            elseif videoScaleType == 1 then -- stretch
                uMin = 1.0 - (1.0-uMin)*(1.0-uMin)*(1.0-uMin)
                uMax = 1.0 - (1.0-uMax)*(1.0-uMax)*(1.0-uMax)
            elseif videoScaleType == 2 then -- mirror
                uMin = 1.0 - (1.0-uMin)*(1.0-uMin)*(1.0-uMin)
                uMax = 1.0 - (1.0-uMax)*(1.0-uMax)*(1.0-uMax)
            elseif videoScaleType == 3 then -- ouroboros
                uMin = ((i%12)+0.0001)/12
                uMax = ((i%12)+1.0001)/12

                if i % 2 == 1 then
                    local temp = uMin
                    uMin = uMax
                    uMax = temp
                end
            elseif videoScaleType == 4 then -- upside down
                vMin = 0.99999
                vMax = 0.00001
                
                uMin = ((i%3)+0.0001)/3
                uMax = ((i%3)+1.0001)/3	
            elseif videoScaleType == 5 then -- tiled
                vMin = 0.00001
                vMax = 0.99999
                
                uMin = ((i%3)+0.0001)/3
                uMax = ((i%3)+1.0001)/3
            elseif videoScaleType == 6 then -- tiled really big
                uMin = ((i%8)+0.0001)/8
                uMax = ((i%8)+1.0001)/8
            elseif videoScaleType == 7 then -- tiled big
                uMin = ((i%12)+0.0001)/12
                uMax = ((i%12)+1.0001)/12
            elseif videoScaleType == 8 then -- tiled single
                uMin = 0.0001
                uMax = 0.9999
                vMin = 0.0001
                vMax = 0.9999
            elseif videoScaleType == 9 then -- tilled double
                uMin = ((i%2)+0.0001)/2
                uMax = ((i%2)+1.0001)/2
            elseif videoScaleType == 10 then -- two by two
                vMin = 0.00001
                vMax = 0.99999
                
                uMin = ((i%2)+0.0001)/2
                uMax = ((i%2)+1.0001)/2
            elseif videoScaleType == 11 then -- tiled off
                vMin = 0.00001
                vMax = 0.99999
                
                uMin = (((i+1)%3)+0.0001)/3
                uMax = (((i+1)%3)+1.0001)/3
            elseif videoScaleType == 12 then -- tiled 2x4
                uMin = ((i%6)+0.0001)/6
                uMax = ((i%6)+1.0001)/6
            elseif videoScaleType == 13 then -- tiled double
                if ((i) % 4 ) < 2 then
                    uMin = ((i%2)+0.0001)/2
                    uMax = ((i%2)+1.0001)/2
                else
                    uMin = 0.97
                    uMax = 0.97
                end
            elseif videoScaleType == 14 then -- bluescreen
                if i % 8 >= 1 and i%8 < 7 then
                    uMin = (((i-1)%8)+0.0001)/6
                    uMax = (((i-1)%8)+1.0001)/6
                else
                    uMin = 0.97
					uMax = 0.97
                end
            end

            EntFire(signName, "SetUMin", uMin, 0)
            EntFire(signName, "SetUMax", uMax, 0)
            EntFire(signName, "SetVMin", vMin, 0)
            EntFire(signName, "SetVMax", vMax, 0)

            EntFire(signName, "Enable", "", 0.1)
        end
    end
end